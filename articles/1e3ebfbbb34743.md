---
title: "AWS SAMã‚’ä½¿ç”¨ã—ã¦SQS Ã— Lambdaéƒ¨åˆ†ãƒãƒƒãƒå¿œç­”"
emoji: "ğŸ“˜"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["go", "Docker", "Lambda", "SAM"]
published: false
---

# ã¯ã˜ã‚ã«

* 2021å¹´11æœˆã‹ã‚‰AWS LambdaãŒSQSã¸ã®éƒ¨åˆ†ãƒãƒƒãƒå¿œç­”ã®ã‚µãƒãƒ¼ãƒˆã‚’é–‹å§‹ã—ãŸã€‚
  * éƒ¨åˆ†ãƒãƒƒãƒå¿œç­”ï¼šãƒãƒƒãƒã®å¤±æ•—ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ã‚’SQSã«æˆ»ã™ã“ã¨ãŒã§ãã‚‹ã€‚
* æœ¬è¨˜äº‹ã§ã¯AWS SAMã‚’ç”¨ã„ãŸãƒªã‚½ãƒ¼ã‚¹ã®è¨­å®šã¨Goã«ã‚ˆã‚‹é–¢æ•°å®Ÿè£…ã‚’èª¬æ˜ã™ã‚‹ã€‚

https://aws.amazon.com/jp/about-aws/whats-new/2021/11/aws-lambda-partial-batch-response-sqs-event-source/?nc1=h_ls

å®Ÿè£…æ™‚ã«ã¯ã“ã¡ã‚‰ã®è¨˜äº‹ã‚’å¤§ã„ã«å‚è€ƒã«ã•ã›ã¦ã„ãŸã ã„ãŸã€‚
ã“ã¡ã‚‰ã®è¨˜äº‹ã§ã¯CDKã‚’ç”¨ã„ãŸå®Ÿè£…æ–¹æ³•ã‚’è§£èª¬ã—ã¦ã„ã‚‹ãŒã€æœ¬è¨˜äº‹ã§ã¯SAMã§ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ã‚’è¡Œã£ã¦ã„ãã€‚

https://zenn.dev/shinshin/articles/72afe65e1cf5ce

# ã‚¤ãƒ³ãƒ•ãƒ©ã®è¨­å®š
```yaml:template.yaml
  Queue:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 60
      MessageRetentionPeriod: !Ref MessageRetentionPeriod
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt MyDeadLetterQueue.Arn
        maxReceiveCount: 2

  DeadLetterQueue:
    Type: AWS::SQS::Queue

  Function:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: cmd
      Handler: main
      Runtime: go1.x
      Role: !GetAtt LambdaExecutionRole.Arn

  FunctionSQSEvent:
    Type: AWS::Lambda::EventSourceMapping
    BatchSize: 100
    EventSourceArn: !GetAtt SQS.Arn
    FunctionName: !Ref Function
    FunctionResponseTypes:
      - ReportBatchItemFailures
    MaximumBatchingWindowInSeconds: 60
```

:::details AWS::Serverless::Functionã®Eventãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ä½¿ãˆãªã„
* `AWS::Serverless::Function`ãƒªã‚½ãƒ¼ã‚¹ã¯æœ¬æ¥ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚¹ãƒãƒƒãƒ”ãƒ³ã‚°ã®è¨­å®šã‚‚ä»¥ä¸‹ã®ã‚ˆã†ã«åˆ†é›¢ã›ãšã«æ›¸ãã“ã¨ãŒã§ãã‚‹ã€‚

```yaml:
Function:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: cmd
      Handler: main
      Runtime: go1.x
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt CrawlingResultQueue.Arn
            BatchSize: 1
```

ã—ã‹ã—ã€2022/04ç¾åœ¨`Events`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä»¥ä¸‹ã«è¨­å®šã™ã‚‹SQSã‚¤ãƒ™ãƒ³ãƒˆã§éƒ¨åˆ†ãƒãƒƒãƒå¿œç­”ã«å¿…è¦ãªä»¥ä¸‹ã®è¨­å®šã‚’æ›¸ãã“ã¨ãŒã§ããªã„ã€‚
```yaml:
FunctionResponseTypes:
      - ReportBatchItemFailures
```
ãªã®ã§ã—ã‚‡ã†ãŒãªãç‹¬è‡ªã«ãƒªã‚½ãƒ¼ã‚¹å®šç¾©ã—ã¦Lambdaãƒªã‚½ãƒ¼ã‚¹ã¨ã®ç´ä»˜ã‘ã‚’è¡Œã†ã€‚
ä»Šå›ã«é™ã£ã¦è¨€ãˆã°SAMã‚’ä½¿ã†æ—¨å‘³ã¯ã‚ã¾ã‚Šãªã„ã‚“ã ãŒã€ã¾ããƒ­ãƒ¼ã‚«ãƒ«å‹•ä½œç¢ºèªã¨ã‹è€ƒãˆã‚‹ã¨ãƒ”ãƒ¥ã‚¢ãªCloudformationã‚’ä½¿ã†ã‚ˆã‚Šãƒã‚·ãªã¯ãšã€ã€

:::